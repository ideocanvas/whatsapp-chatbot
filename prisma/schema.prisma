// Prisma schema for WhatsApp Chatbot
// This schema supports both PostgreSQL and SQLite for migration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Conversation logs for long-term conversation history
model ConversationLog {
  id          String   @id @default(uuid())
  userId      String
  message     String
  role        Role
  timestamp   DateTime
  messageType MessageType
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([role])
}

// Knowledge base for storing facts learned from autonomous browsing
model Knowledge {
  id             String   @id @default(uuid())
  content        String
  vector         Bytes    // BLOB storage for embeddings
  source         String?
  category       String?
  tags           Json?    // JSON array of tags
  timestamp      DateTime
  relevanceScore Float?   @default(0.0)

  @@index([category])
  @@index([timestamp])
  @@index([relevanceScore])
}

// Processed messages to prevent duplicate processing
model ProcessedMessage {
  messageId     String   @id
  processedAt   DateTime @default(now())
  senderNumber String?
  messageType   String?

  @@index([processedAt])
}

// Vector store documents for RAG searches
model Document {
  id       String   @id @default(uuid())
  content  String
  vector   Bytes    // BLOB storage for embeddings
  source   String?
  date     String?
  category String?
  title    String?
  createdAt DateTime @default(now())

  @@index([category])
  @@index([createdAt])
}

enum Role {
  user
  assistant
}

enum MessageType {
  text
  image
  audio
}

// Conversation summaries for long-term memory
model ConversationSummary {
  id          String   @id @default(uuid())
  userId      String
  summary     String
  timestamp   DateTime
  contextHash String   // Hash of the conversation context for deduplication
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@unique([userId, contextHash])
}

// User profiles for structured personal information storage
model UserProfile {
  userId        String   @id
  name          String?
  location      String?
  language      String?  @default("en")
  
  // Structured facts (JSONB in Postgres)
  // Example: { "job": "Engineer", "hobby": "Hiking", "pet": "Dog named Rex" }
  facts         Json     @default("{}")
  
  // Metadata for proactivity
  completeness  Int      @default(0) // 0-100 score of how much we know
  lastAsked     DateTime? // When did we last ask a personal question?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}