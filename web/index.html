<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Autonomous WhatsApp Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        whatsapp: {
                            green: '#25D366',
                            dark: '#075E54',
                            light: '#128C7E',
                            message: {
                                sent: '#DCF8C6',
                                received: '#FFFFFF'
                            }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="dashboard()" x-init="init()" class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-whatsapp-dark text-white flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b border-whatsapp-light">
                <h1 class="text-xl font-bold">ü§ñ WhatsApp Agent</h1>
                <p class="text-whatsapp-light text-sm" x-text="botInfo.name"></p>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-2">
                <button @click="activeTab = 'overview'" 
                        :class="activeTab === 'overview' ? 'bg-whatsapp-light' : 'hover:bg-whatsapp-light/50'"
                        class="w-full text-left p-3 rounded-lg transition-colors">
                    üìä Overview
                </button>
                <button @click="activeTab = 'chat'" 
                        :class="activeTab === 'chat' ? 'bg-whatsapp-light' : 'hover:bg-whatsapp-light/50'"
                        class="w-full text-left p-3 rounded-lg transition-colors">
                    üí¨ Test Chat
                </button>
                <button @click="activeTab = 'memory'" 
                        :class="activeTab === 'memory' ? 'bg-whatsapp-light' : 'hover:bg-whatsapp-light/50'"
                        class="w-full text-left p-3 rounded-lg transition-colors">
                    üß† Memory
                </button>
                <button @click="activeTab = 'activity'" 
                        :class="activeTab === 'activity' ? 'bg-whatsapp-light' : 'hover:bg-whatsapp-light/50'"
                        class="w-full text-left p-3 rounded-lg transition-colors">
                    üìù Activity Log
                </button>
            </nav>

            <!-- Status & Actions -->
            <div class="p-4 border-t border-whatsapp-light space-y-3">
                <!-- Status Indicator -->
                <div class="flex items-center space-x-2 text-sm">
                    <div class="w-2 h-2 rounded-full" 
                         :class="status.agent ? 'bg-green-400' : 'bg-red-400'"></div>
                    <span x-text="status.agent ? 'Agent Active' : 'Agent Offline'"></span>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-2">
                    <button @click="triggerBrowsing()" 
                            class="w-full bg-whatsapp-green text-white p-2 rounded text-sm hover:bg-green-600 transition-colors">
                        üåê Browse Now
                    </button>
                    <button @click="refreshKnowledge()" 
                            class="w-full bg-blue-500 text-white p-2 rounded text-sm hover:bg-blue-600 transition-colors">
                        üìö Update Knowledge
                    </button>
                </div>

                <!-- Logout -->
                <button @click="logout()" 
                        class="w-full bg-gray-600 text-white p-2 rounded text-sm hover:bg-gray-700 transition-colors">
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Top Bar -->
            <header class="bg-white border-b p-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold" x-text="getTabTitle()"></h2>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600">
                            Auto-refresh: 
                            <input type="checkbox" x-model="autoRefresh" class="ml-2">
                        </div>
                        <button @click="refreshAll()" class="bg-whatsapp-green text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 p-6 overflow-auto">
                <!-- Overview Tab -->
                <div x-show="activeTab === 'overview'" class="space-y-6">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-2xl font-bold text-whatsapp-dark" x-text="status.memory?.context?.activeUsers || 0"></div>
                            <div class="text-gray-600">Active Users</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-2xl font-bold text-whatsapp-dark" x-text="status.memory?.knowledge?.totalDocuments || 0"></div>
                            <div class="text-gray-600">Knowledge Docs</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-2xl font-bold text-whatsapp-dark" x-text="status.scheduler?.tickCount || 0"></div>
                            <div class="text-gray-600">Scheduler Ticks</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="text-2xl font-bold text-whatsapp-dark" x-text="status.browser?.totalSessions || 0"></div>
                            <div class="text-gray-600">Browse Sessions</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b">
                            <h3 class="font-semibold">Recent Activity</h3>
                        </div>
                        <div class="p-4 max-h-64 overflow-y-auto">
                            <template x-for="activity in activities.slice(-10).reverse()" :key="activity.timestamp">
                                <div class="py-2 border-b last:border-b-0">
                                    <div class="text-sm text-gray-600" x-text="new Date(activity.timestamp).toLocaleString()"></div>
                                    <div class="font-medium" x-text="activity.message"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Chat Tab -->
                <div x-show="activeTab === 'chat'" class="h-full flex flex-col">
                    <div class="bg-white rounded-lg shadow flex-1 flex flex-col">
                        <!-- Chat Header -->
                        <div class="p-4 border-b bg-whatsapp-green text-white rounded-t-lg">
                            <h3 class="font-semibold" x-text="botInfo.name"></h3>
                            <div class="text-sm opacity-90">Test Chat Interface</div>
                        </div>

                        <!-- Messages -->
                        <div class="flex-1 p-4 overflow-y-auto space-y-3" id="chat-messages">
                            <template x-for="message in chatMessages" :key="message.id">
                                <div :class="message.sender === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                    <div :class="message.sender === 'user' ? 'bg-whatsapp.message.sent' : 'bg-whatsapp.message.received border'"
                                         class="max-w-xs lg:max-w-md rounded-lg p-3 shadow">
                                        <div class="font-medium" x-text="message.sender === 'user' ? 'You' : botInfo.name"></div>
                                        <div class="mt-1" x-text="message.text"></div>
                                        <div class="text-xs text-gray-500 mt-1 text-right" x-text="message.time"></div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Input -->
                        <div class="p-4 border-t">
                            <div class="flex space-x-2">
                                <input x-model="chatInput" 
                                       @keypress.enter="sendMessage()"
                                       type="text" 
                                       placeholder="Type a message..." 
                                       class="flex-1 border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-whatsapp-green">
                                <button @click="sendMessage()" 
                                        class="bg-whatsapp-green text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memory Tab -->
                <div x-show="activeTab === 'memory'" class="space-y-6">
                    <!-- Memory Type Selector -->
                    <div class="flex space-x-2">
                        <button @click="memoryType = 'context'" 
                                :class="memoryType === 'context' ? 'bg-whatsapp-dark text-white' : 'bg-white text-gray-700'"
                                class="px-4 py-2 rounded-lg border transition-colors">
                            Context
                        </button>
                        <button @click="memoryType = 'knowledge'" 
                                :class="memoryType === 'knowledge' ? 'bg-whatsapp-dark text-white' : 'bg-white text-gray-700'"
                                class="px-4 py-2 rounded-lg border transition-colors">
                            Knowledge
                        </button>
                        <button @click="memoryType = 'history'" 
                                :class="memoryType === 'history' ? 'bg-whatsapp-dark text-white' : 'bg-white text-gray-700'"
                                class="px-4 py-2 rounded-lg border transition-colors">
                            History
                        </button>
                    </div>

                    <!-- Search for Knowledge -->
                    <div x-show="memoryType === 'knowledge'" class="bg-white p-4 rounded-lg shadow">
                        <div class="flex space-x-2">
                            <input x-model="searchQuery" 
                                   @keypress.enter="searchKnowledge()"
                                   type="text" 
                                   placeholder="Search knowledge base..." 
                                   class="flex-1 border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-whatsapp-green">
                            <button @click="searchKnowledge()" 
                                    class="bg-whatsapp-green text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Memory Content -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b">
                            <h3 class="font-semibold" x-text="memoryType.charAt(0).toUpperCase() + memoryType.slice(1) + ' Data'"></h3>
                        </div>
                        <div class="p-4 max-h-96 overflow-y-auto">
                            <template x-for="item in memoryData" :key="item.id">
                                <div class="py-3 border-b last:border-b-0">
                                    <div class="flex justify-between items-start">
                                        <div class="font-medium" x-text="item.title || item.id"></div>
                                        <div class="text-sm text-gray-500" x-text="new Date(item.timestamp).toLocaleString()"></div>
                                    </div>
                                    <div class="mt-2 text-gray-700" x-text="item.content || item.message"></div>
                                    <div class="mt-2 flex space-x-4 text-sm text-gray-500">
                                        <template x-if="item.category">
                                            <span x-text="'Category: ' + item.category"></span>
                                        </template>
                                        <template x-if="item.source">
                                            <span x-text="'Source: ' + item.source"></span>
                                        </template>
                                        <template x-if="item.relevance">
                                            <span x-text="'Relevance: ' + item.relevance"></span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Activity Log Tab -->
                <div x-show="activeTab === 'activity'" class="h-full">
                    <div class="bg-white rounded-lg shadow h-full flex flex-col">
                        <div class="p-4 border-b">
                            <h3 class="font-semibold">Real-time Activity Log</h3>
                        </div>
                        <div class="p-4 flex-1 overflow-y-auto font-mono text-sm">
                            <template x-for="activity in activities" :key="activity.timestamp">
                                <div class="py-1 border-b last:border-b-0">
                                    <span class="text-gray-500" x-text="new Date(activity.timestamp).toLocaleTimeString()"></span>
                                    <span :class="{
                                        'text-green-600': activity.type === 'info',
                                        'text-red-600': activity.type === 'error', 
                                        'text-yellow-600': activity.type === 'warning'
                                    }" x-text="' ' + activity.message"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                activeTab: 'overview',
                memoryType: 'context',
                autoRefresh: true,
                chatInput: '',
                searchQuery: '',
                
                // Data stores
                botInfo: { name: 'Autonomous WhatsApp Agent' },
                status: {},
                activities: [],
                memoryData: [],
                chatMessages: [
                    {
                        id: 1,
                        sender: 'bot',
                        text: 'Hello! I\'m your autonomous WhatsApp assistant. How can I help you today?',
                        time: new Date().toLocaleTimeString()
                    }
                ],

                // Methods
                async init() {
                    await this.loadBotInfo();
                    await this.refreshAll();
                    this.startAutoRefresh();
                },

                async loadBotInfo() {
                    try {
                        const response = await fetch('/api/bot-info');
                        this.botInfo = await response.json();
                    } catch (error) {
                        console.error('Error loading bot info:', error);
                    }
                },

                async refreshAll() {
                    await Promise.all([
                        this.loadStatus(),
                        this.loadActivities(),
                        this.loadMemoryData()
                    ]);
                },

                async loadStatus() {
                    try {
                        const response = await fetch('/api/status');
                        this.status = await response.json();
                    } catch (error) {
                        console.error('Error loading status:', error);
                    }
                },

                async loadActivities() {
                    try {
                        const response = await fetch('/api/activity');
                        this.activities = await response.json();
                    } catch (error) {
                        console.error('Error loading activities:', error);
                    }
                },

                async loadMemoryData() {
                    try {
                        const response = await fetch(`/api/memory/${this.memoryType}`);
                        this.memoryData = await response.json();
                    } catch (error) {
                        console.error('Error loading memory data:', error);
                    }
                },

                async sendMessage() {
                    if (!this.chatInput.trim()) return;

                    const message = this.chatInput.trim();
                    this.chatInput = '';

                    // Add user message
                    this.chatMessages.push({
                        id: Date.now(),
                        sender: 'user',
                        text: message,
                        time: new Date().toLocaleTimeString()
                    });

                    // Scroll to bottom
                    this.$nextTick(() => {
                        const container = document.getElementById('chat-messages');
                        container.scrollTop = container.scrollHeight;
                    });

                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message, userId: 'web-user' })
                        });

                        const data = await response.json();
                        
                        // Add bot response
                        this.chatMessages.push({
                            id: Date.now() + 1,
                            sender: 'bot',
                            text: data.response,
                            time: new Date().toLocaleTimeString()
                        });

                        // Scroll to bottom again
                        this.$nextTick(() => {
                            const container = document.getElementById('chat-messages');
                            container.scrollTop = container.scrollHeight;
                        });

                    } catch (error) {
                        this.chatMessages.push({
                            id: Date.now() + 1,
                            sender: 'bot',
                            text: 'Sorry, I encountered an error. Please try again.',
                            time: new Date().toLocaleTimeString()
                        });
                    }
                },

                async searchKnowledge() {
                    if (!this.searchQuery.trim()) return;

                    try {
                        const response = await fetch('/api/search/knowledge', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: this.searchQuery })
                        });

                        this.memoryData = await response.json();
                        this.memoryType = 'knowledge';
                    } catch (error) {
                        console.error('Error searching knowledge:', error);
                    }
                },

                async triggerBrowsing() {
                    try {
                        await fetch('/api/browse/now', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ intent: 'general' })
                        });
                        await this.loadActivities();
                    } catch (error) {
                        console.error('Error triggering browsing:', error);
                    }
                },

                async refreshKnowledge() {
                    try {
                        await fetch('/api/knowledge/refresh', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        await this.loadActivities();
                    } catch (error) {
                        console.error('Error refreshing knowledge:', error);
                    }
                },

                async logout() {
                    try {
                        await fetch('/api/logout', { method: 'POST' });
                        window.location.href = '/login.html';
                    } catch (error) {
                        console.error('Error logging out:', error);
                    }
                },

                startAutoRefresh() {
                    setInterval(() => {
                        if (this.autoRefresh) {
                            this.refreshAll();
                        }
                    }, 5000);
                },

                getTabTitle() {
                    const titles = {
                        overview: 'System Overview',
                        chat: 'Test Chat',
                        memory: 'Memory Management',
                        activity: 'Activity Log'
                    };
                    return titles[this.activeTab] || 'Dashboard';
                }
            }
        }

        // Auto-scroll chat to bottom on load
        document.addEventListener('alpine:initialized', () => {
            setTimeout(() => {
                const container = document.getElementById('chat-messages');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        });
    </script>
</body>
</html>